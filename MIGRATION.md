# 数据库迁移使用说明

## 🔄 新的启动方式

为了提高应用启动速度，现在数据库迁移（AutoMigrate）已从自动执行改为手动触发。

### 正常启动服务（推荐）
```bash
# 正常启动，不执行数据库迁移
go run main.go

# 或者编译后运行
go build -o app
./app
```

### 执行数据库迁移
```bash
# 执行数据库迁移（仅在需要时运行）
go run main.go -migrate

# 或者编译后运行
go build -o app
./app -migrate
```

## 🚀 什么时候需要执行迁移？

### 需要执行迁移的情况：
- ✅ 第一次运行项目
- ✅ 修改了数据表结构（models）
- ✅ 添加了新的字段或索引
- ✅ 更新了外键关系

### 不需要执行迁移的情况：
- ❌ 日常开发启动
- ❌ 代码逻辑修改
- ❌ 前端界面调整
- ❌ API 接口修改（不涉及数据表结构）

## 🛠️ 使用示例

### 初次设置项目
```bash
# 1. 启动数据库
docker-compose up mysql -d

# 2. 执行数据库迁移（创建表和初始数据）
go run main.go -migrate

# 3. 正常启动服务
go run main.go
```

### 日常开发
```bash
# 日常开发只需要正常启动即可
go run main.go
```

### 更新数据表结构后
```bash
# 修改了 models/*.go 文件后，执行一次迁移
go run main.go -migrate

# 然后正常启动
go run main.go
```

## 📊 效果对比

### 修改前（每次启动都迁移）：
```
2025/01/20 10:30:15 配置加载成功
2025/01/20 10:30:15 数据库连接成功
2025/01/20 10:30:15 SELECT DATABASE()
2025/01/20 10:30:15 SELECT VERSION()
2025/01/20 10:30:15 SELECT count(*) FROM information_schema.tables WHERE table_schema = CURRENT_DATABASE() AND table_name = 'tags' AND table_type = 'BASE TABLE'
[大量SQL检查语句...]
2025/01/20 10:30:16 数据表迁移完成
2025/01/20 10:30:16 检测到已有标签数据，跳过初始化
2025/01/20 10:30:16 服务器启动在端口: :8080
```

### 修改后（正常启动）：
```
2025/01/20 10:30:15 配置加载成功
2025/01/20 10:30:15 跳过数据库迁移，正常启动服务...
2025/01/20 10:30:15 数据库连接成功
2025/01/20 10:30:15 服务器启动在端口: :8080
```

**启动时间减少约 80%！** 🚀

## 🔧 便捷脚本

我们提供了便捷脚本来简化操作：

### Windows 用户
```cmd
# 执行迁移
scripts\migrate.bat

# 正常启动
scripts\dev.bat
```

### Linux/Mac 用户
```bash
# 执行迁移
./scripts/migrate.sh

# 正常启动
./scripts/dev.sh
```

## ⚠️ 注意事项

1. **数据安全**：迁移操作是非破坏性的，不会删除您的数据
2. **生产环境**：建议在生产环境部署时单独执行迁移步骤
3. **团队协作**：当团队成员更新了数据表结构时，记得执行一次迁移
4. **错误处理**：如果迁移失败，请检查数据库连接和权限
